# LiveReCBot
#### Live Recording Cut Bot for Bilibili Live

**********

[中文README| Chinese](README_CN.md)
<br>[日本語README | Japanese](README_JP.md)

## Introduction

**********

* This project is aiming at automatically suppressing danmaku, generating danmaku density curve and processing hot clips from live recordings.
* This is a one-man project and I made it for my own use, mostly for CS2 game commentary clips.
* It still __cannot reach the level of all-time automation__, but it can save me a lot of time when making clips.
* I will continue to update it and add more functions in the future.
* If you are insterested in where I am going, feel free to contact me.
* __*<u>[TOKO的小嘴巴](https://space.bilibili.com/202371545?spm_id_from=333.337.0.0)</u>*__ is my Bilibili account and most of the recent videos uploaded are based on this project.
* In case you are interested in CS2 game competition and want to find a Chinese commentator on Bilibili, __subscribe __*<u>[老懂哥0ff1c1aL](https://space.bilibili.com/475083446?spm_id_from=333.337.0.0)</u>*__ for CS2 game commentary__. He will give a commentary on every game if there is no copyright infringement. No matter day or night.

## Requirements

**********

* Python (__Better use Python 3.6 or higher__, lower versions are not tested)
* numpy (The new python version should have it by default but better to check if  your computer has it)
```
    pip install numpy
```
* <u>[FFmpeg](https://www.gyan.dev/ffmpeg/builds/)</u> ==(__Ensure that FFmpeg is in the system environment variables or the video process functions will not work__)==
*You can install ffmpeg through git as well*
```
    git clone https://git.ffmpeg.org/ffmpeg.git ffmpeg

    cd ffmpeg

    ./configure --enable-shared

    make

    sudo make install
```
* matplotlib
```
    pip install matplotlib
```
* PyQt5
```
    pip install PyQt5
```
* PyInstaller
```
    pip install pyinstaller
```
* flask
```
    pip install flask
```
* <u>[Danmuji (or BiliLiveRecorder)]( https://github.com/BililiveRecorder/BililiveRecorder/releases)</u>

## Usage

**********

### Direct install

If you directly download the executable file from Release, you can run it without installing anything.

### Install from source code

* Clone the repository
* Install all requirements
* Install LiveRecBot
 ```
    pyinstaller --onefile --windowed --dist LiveRecBot -i LRB.ico LiveRecBot.py
```
* Go to the LiveRecBot directory and run __LiveRecBot.exe__
* The default file directory would be created in the same directory as the executable as you run it.
* Choose one function to use.

### Functions

**********

#### Suppress .xml danmaku and .flv video files
* Click __Select Video File__ and __Select Danmaku File__ to choose files to be processed.
* Click __Select Video Output Path__ and __Select Image Output Path__ to set the out put file path.
* Click __Process Video__ to start processing.

#### Generate danmaku density curve image
* Click __Select Danmaku File__ to choose the danmaku file to be processed.
* Click __Select Image Output Path__ to set the out put file path.
* Click __Process Danmaku Only__ to start processing.

#### Auto suppress and generate hot clips
* Click __Select Video Output Path__ and __Select Image Output Path__ to set the out put file path.
* Set webhook interface inside Danmuji: https://host:port//webhook (__The default port is 5000__)
* Enter the webhook interface address in the Webhook text box.
* Click __Start Listening__. You can close the window now and the program will continue to run in the background.

## File Directory

**********

| File Name | Description |
| --------- | ----------- |
| LiveRecBot.py | Main program |
| curve_plotter.py | Generate danmaku density curve <br>Send ffmpeg command to process clips|
| density_calculator.py | Calculate danmaku density |
| flask_app.py | Flask webhook server |
| global_vars.py | Global variables |
| log_manager.py | Delete overtime log files |
| logger_config.py | Logger configuration |
| main_window.py | Main window GUI |
| video_processor.py | Suppress danmaku and video files |
| webhook_listener.py | Listen to webhook <br>Read json from BililiveRecorder |
| xml_parser.py | Parse danmaku xml file |
| LRB.ico | Possible application icon |
| LRB.png | Possible tray icon |

You can chage the icon as you like. ~~The default icon is generated by AI~~.
 But remember ==__use .ico file for application icon and .png file for tray icon__==.

 ## Tips

**********

* The auto clip generation is __not a complete function yet__, it will give you 5 minutes clip around the time where the danmaku density is __1.5 times higher than the average__. 
* Time duration is set to be 5 minutes due to __CS2 game duration per round and danmaku latency__.
* Density threshold is set by experiment based on live recordings of __*<u>[老懂哥](https://live.bilibili.com/21674333?broadcast_type=0&is_room_feed=1&spm_id_from=333.999.to_liveroom.0.click&live_from=86002)</u>*__, it may not be accurate for your live recordings.
* You can chage threshold in the code (__at line 53, curve_plotter.py__) to adjust the sensitivity. Relative function is under development.
* As the processing will generate a density curve image, you can use it to adjust the threshold or cut the video.
* The density curve image is set to be saved at __300 dpi__, you can see the detail of the curve by zooming in.
* Log files would be deleted __every 30 days__ if the program is running. If you closed the program, the log files would not be deleted. But once you restart LRB, overtime log files would be deleted.

## Known Issues

**********

* __This version only supports one video file and one danmaku file at a time__. Avoid manual processing when streaming is running or the auto cut funtion will not work. __Multiple files is under development__.
* __This version only supports .xml danmaku files__. Though many use .ass danmaku files in video editing, BililiveRecorder automatically save .xml danmaku files, so you can use it directly. No need to transcode.
* __The tray icon only supports .png file__. Actually I have no idea why .ico file does not work. ~~Maybe Python is not the same as C++.~~ :)

### More information see [CHANGELOG](CHANGELOG.md)

## Reference

**********

* https://github.com/BililiveRecorder/BililiveRecorder
* https://rec.danmuji.org/reference/webhook/ Used as a reference for webhook parameters.
* https://www.cnblogs.com/ghgxj/p/14219075.html Used as a reference for xml danmaku parameters.